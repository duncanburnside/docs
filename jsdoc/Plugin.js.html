<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Plugin.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: Plugin.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
	core module for define and manage Kepler plugins
*/

//TODO execute code inside Plugin() at Meteor.startup(), not immediately. for using K.settings

//TODO create handlebars helper to check is a placeholder have plugins
//
Kepler.plugins = {};

/** @namespace */
Kepler.Plugin = function(plugin) {
	
	if(plugin &amp;&amp; _.isString(plugin.name) &amp;&amp; plugin.name!=='')
	{
		if(!this.plugins[plugin.name]) {

			var ptmpls = plugin.templates;

			if(_.isObject(ptmpls)) {

				for(var placeholder in ptmpls) {

					if(ptmpls[placeholder] &amp;&amp; !_.has(K.templates,placeholder) )
						K.templates[placeholder]= {};
				}

				for(var placeholder in K.templates) {
					if(_.isObject(K.templates[placeholder]) &amp;&amp; ptmpls[placeholder]) {
						
						var tt = K.Plugin.normalizePlaceholders(ptmpls[placeholder], plugin.name);
						
						_.extend(K.templates[placeholder], tt);
					}
				}
			}
			
			if(_.isObject(plugin.filters))
				_.deepExtend(K.filters, plugin.filters);
			
			if(_.isObject(plugin.schemas))
				_.deepExtend(K.schemas, plugin.schemas);

			if(_.isObject(plugin.settings))
				_.deepExtend(K.settings, plugin.settings);

			this.plugins[plugin.name] = plugin;
		}
		else
			console.warn("Plugin: just defined", plugin)
	}
	else
		console.warn("Plugin: require name", plugin)
};
/**
 * fill not defined fields with defaults values in plugin config teomplates
 * @param  {Array} tt [description]
 * @return {Array}    [description]
 */
Kepler.Plugin.normalizePlaceholders = function(tmpls, plugin) {
	
	//TODO add new field 'replace'
	
	if(_.isString(tmpls))
		tmpls = _.object([tmpls],[true]);
	
	for(var t in tmpls) {
		if(tmpls[t]===true)
			tmpls[t]= {};

		if(_.isObject(tmpls[t])) {
			tmpls[t]= _.defaults(tmpls[t], {
				plugin: plugin,
				show: true,
				order: 0
			});
		}
		else if(tmpls[t]===false)
			tmpls[t]= {show: false};
	}
	return tmpls;
};
/**
 * return list od templates names for certain Kepler placeholder
 * @param  {String} kepler placeholder name
 * @param  {Object} data for each templates
 * @param  {String} separator
 * @return {Array}
 */
Kepler.Plugin.templatesByPlaceholder = function(placeholder, data, sep) {
	
	sep = sep || "\n";

	var tmpls = [],
		sorts = [];

	if(!placeholder
		//TODO uncomment and decide if check also it.. || !Template[placeholder]
		) return tmpls;

	for(var parentName in K.templates) {

		if(parentName === placeholder) {

			//convert in array of objects
			//TODO https://stackoverflow.com/questions/49611332/underscorejs-object-to-collection
			var arr = _.map(K.templates[parentName], function(v,k) {
				v.name = k;
				return v;
			});

			sorts = _.sortBy(arr, 'order');

			var len = sorts.length-3;
			for(var s in sorts) {
				if(sorts[s].show) {
					tmpls.push({
						pluginTemplate: sorts[s].name,
						pluginData: data,
						pluginSep: s&lt;len ? sep : ''
					});
				}
			}
		}
	}

	return tmpls;	
};

if(Meteor.isClient) {
	Meteor.startup(function() {
		var sets = K.settings.public.templates;

		for(var placeholder in K.templates) {
			
			var tmpls = K.templates[placeholder];

			for(var t in tmpls) {
				if(!Template[t]) {
					console.warn('Template not exists: "'+t+'", defined in plugin: '+(tmpls[t] &amp;&amp; tmpls[t].plugin))
					delete tmpls[t];
				}
			}
		}

		for(var placeholder in sets) {

			if(sets[placeholder].show===false)
				delete K.templates[placeholder];

			if(!K.templates[placeholder]) continue;

			_.extend(K.templates[placeholder], K.Plugin.normalizePlaceholders(sets[placeholder]) );
		}

	});
}

if(Meteor.isServer) {
	Meteor.startup(function() {
		console.log('Plugins: ', _.keys(K.plugins).join(','));
	});
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="Kepler.Cache.html">Cache</a></li><li><a href="Kepler.filters.html">filters</a></li><li><a href="Kepler.Plugin.html">Plugin</a></li><li><a href="Kepler.schemas.html">schemas</a></li><li><a href="Kepler.templates.html">templates</a></li><li><a href="Kepler.Util.html">Util</a></li><li><a href="Util.Kepler.Util.geo.html">Kepler.Util.geo</a></li><li><a href="Util.Kepler.Util.humanize.html">Kepler.Util.humanize</a></li><li><a href="Util.Kepler.Util.sanitize.html">Kepler.Util.sanitize</a></li><li><a href="Util.Kepler.Util.valid.html">Kepler.Util.valid</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Feb 05 2019 15:57:23 GMT+0100 (Central European Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
