<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: core/client/Profile.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: core/client/Profile.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Module for logged user profile
 * @namespace
 * @memberOf Kepler
 * @name  Profile
 */
Kepler.Profile = {

	ready: false,

	id: null,
	user: null,
	data: {},
	placeCheckin: null,

	_deps: {
		online: new Tracker.Dependency()
	},

	init: function(cb) {

		var self = this;

		if(self.ready)
			return self;
		else
			self.ready = true;

		Tracker.autorun(function() {

			self.id = Meteor.userId();
			self.data = Meteor.user();
		
			if(!self.data)	//onlogout
				return self.ready = false;

			self.user = K.userById(self.id);
			self.user.update()

			if(self.data.checkin)
				self.placeCheckin = K.placeById(self.data.checkin);
		
			if(self.data.status==='online' || self.data.status==='away')
				Meteor.subscribe('friendsByIds', K.Profile.data.friends, function() {
					_.map(K.Profile.data.friends, function(id) {
						K.Map.addItem(K.userById(id));
					});
				});
			else {
				_.map(K.Profile.data.friends, function(id) {
					K.Map.removeItem(K.userById(id));
				});
			}
		
		});

		var mob = K.Util.isMobile();
		if(self.data.mob !== mob)
			self.setMobile(mob);

		if(_.isFunction(cb))
			cb.call(self, self.data);

		return this;
	},
	getOnline: function() {
		var self = this;
		this._deps.online.depend();
		//TODO var mstatus = Meteor.status(); mstatus.connected &amp;&amp;
		return (self.data.status==='online' || self.data.status==='away');
	},	
	setOnline: function(online) {
		var self = this;
		Meteor.call('UserPresence:setDefaultStatus', online?'online':'offline', function(err, data) {
			self._deps.online.changed();
		});
		if(!online &amp;&amp; K.Map.controls.gps)
			K.Map.controls.gps.deactivate();
		return this;
	},
	setLoc: function(loc) {
		var self = this;
		Meteor.call('setLoc', loc, function(err) {
			self.user.update();
			if(self.user &amp;&amp; self.user.icon)
				self.user.icon.animate();
		});
		return this;
	},
	setMobile: function(val) {
		Users.update(Meteor.userId(), {
			$set: {mob: val }
		});
		return this;
	},
	getOpts: function(prop) {
		return K.Util.getPath(this.data,'settings.'+prop);
	},
	hasFriend: function(userId) {
		return _.contains(this.data.friends, userId);
	},
	hasPending: function(userId) {
		return _.contains(this.data.usersPending, userId);
	},
	hasReceive: function(userId) {	
		return _.contains(this.data.usersReceive, userId);
	},
	hasBlocked: function(userId) {
		return _.contains(this.data.usersBlocked, userId);
	},
	friendAdd: function(userId) {
		Meteor.call('friendAdd', userId);
		return this;
	},
	friendConfirm: function(userId) {
		Meteor.call('friendConfirm', userId);
		return this;
	},	
	friendDel: function(userId) {
		Meteor.call('friendDel', userId);
		return this;
	},
	userBlock: function(userId) {
		Meteor.call('userBlock', userId);
		return this;
	},
	userUnblock: function(userId) {
		Meteor.call('userUnblock', userId);
		return this;
	},	
	addCheckin: function(placeId) {
		var self = this;
		Meteor.call('addCheckin', placeId, function() {
			self.placeCheckin = K.placeById(placeId);
			self.user.update();
		});
		return this;
	},
	removeCheckin: function(placeId) {
		var self = this;
		Meteor.call('removeCheckin', placeId, function(err) {
			self.placeCheckin = null;

			//TODO don't use update to force reativity
			self.user.update();
		});
		return this;
	},
	logout: function() {
		this.setOnline(false);
		this.ready = false;
		Meteor.logout();
		return this;
	}
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-filters.html">filters</a></li><li><a href="module-Map.html">Map</a></li><li><a href="module-schemas.html">schemas</a></li><li><a href="module-templates.html">templates</a></li></ul><h3>Classes</h3><ul><li><a href="Class.html">Class</a></li><li><a href="Kepler.Place.html">Place</a></li><li><a href="Kepler.User.html">User</a></li></ul><h3>Namespaces</h3><ul><li><a href="Kepler.html">Kepler</a></li><li><a href="Kepler.Cache.html">Cache</a></li><li><a href="Kepler.Plugin.html">Plugin</a></li><li><a href="Kepler.Profile.html">Profile</a></li><li><a href="Kepler.Util.html">Util</a></li><li><a href="Util.Kepler.Util.geo.html">Kepler.Util.geo</a></li><li><a href="Util.Kepler.Util.humanize.html">Kepler.Util.humanize</a></li><li><a href="Util.Kepler.Util.sanitize.html">Kepler.Util.sanitize</a></li><li><a href="Util.Kepler.Util.valid.html">Kepler.Util.valid</a></li></ul><h3>Global</h3><ul><li><a href="global.html#K">K</a></li><li><a href="global.html#placeById">placeById</a></li><li><a href="global.html#placesById">placesById</a></li><li><a href="global.html#userById">userById</a></li><li><a href="global.html#usersById">usersById</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed Feb 06 2019 12:28:34 GMT+0100 (Central European Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
